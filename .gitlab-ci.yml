# Full project: https://gitlab.com/pages/jekyll
image: ruby:2.3

stages:
    - build
    - test
    - deploy

build:
  stage: build
  script:
  - gem install jekyll
  - echo $(whoami)
  - jekyll build -d test
  - gem uninstall jekyll
  except:
  - master

test:
  stage: test
  script:
  - echo $(whoami)
  - gem install jekyll
  - jekyll build -d test
  - gem uninstall jekyll
  except:
  - master

deploy:
  stage: deploy
  script:
  - echo $(whoami)
  - gem install jekyll
  - jekyll build -d public

  # install ssh-agent
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'

  # run ssh-agent
  - eval $(ssh-agent -s)

  # add ssh key stored in SSH_PRIVATE_KEY variable to the agent store
  - ssh-add <(echo "$SSH_DEPLOY_PRIVATE_KEY")

  # disable host key checking (NOTE: makes you susceptible to man-in-the-middle attacks)
  # WARNING: use only in docker container, if you use it with shell you will overwrite your user's ssh config
  - mkdir -p ~/.ssh
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  - ping -c 4 linode.missionfocus.com
  - scp public/* www@linode.missionfocus.com:~

  - gem uninstall jekyll
  artifacts:
    expire_in: 1 weeks
    paths:
    - public
  only:
  - master
